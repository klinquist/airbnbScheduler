<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Airbnb Lock Code Manager</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 20px;
      }
      .section {
        margin-bottom: 30px;
      }
      .section h2 {
        color: #666;
        font-size: 1.2em;
        margin-bottom: 10px;
      }
      .reservation,
      .visit {
        background-color: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
      }
      .active {
        border-left-color: #28a745;
      }
      .code {
        font-family: monospace;
        font-size: 1.2em;
        padding: 5px 10px;
        background-color: #e9ecef;
        border-radius: 4px;
      }
      .button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        margin-right: 10px;
      }
      .button:hover {
        background-color: #0056b3;
      }
      .button.delete {
        background-color: #dc3545;
      }
      .button.delete:hover {
        background-color: #c82333;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #666;
      }
      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        color: #666;
      }
      .tab.active {
        color: #007bff;
        border-bottom: 2px solid #007bff;
        margin-bottom: -2px;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Airbnb Lock Code Manager</h1>

      <div class="section">
        <h2>Current Active Code</h2>
        <div id="current-code">Loading...</div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('airbnb')">
          Airbnb Reservations
        </button>
        <button class="tab" onclick="showTab('visits')">Manual Visits</button>
        <button class="tab" onclick="showTab('config')">Configuration</button>
      </div>

      <div id="airbnb-tab" class="tab-content active">
        <div class="section">
          <h2>Upcoming Airbnb Reservations</h2>
          <div id="schedules">Loading...</div>
        </div>
      </div>

      <div id="visits-tab" class="tab-content">
        <div class="section">
          <h2>Manual Visits</h2>
          <div id="visits">Loading...</div>
        </div>
        <div class="section">
          <h2>Add New Visit</h2>
          <form id="visit-form">
            <div class="form-group">
              <label for="name">Name</label>
              <input type="text" id="name" required />
            </div>
            <div class="form-group">
              <label for="phone">Phone Number (Optional)</label>
              <input
                type="text"
                id="phone"
                placeholder="Leave blank to skip lock coding"
              />
            </div>
            <div id="mode-changes">
              <div class="mode-change">
                <h3>Mode Change #1</h3>
                <div class="form-group">
                  <label for="time1">Time</label>
                  <input type="datetime-local" id="time1" required />
                </div>
                <div class="form-group">
                  <label for="mode1">Mode</label>
                  <select id="mode1" required>
                    <option value="">Select a mode...</option>
                    <option value="checkin">Check-in Mode</option>
                    <option value="checkout">Check-out Mode</option>
                    <option value="arriving_soon">Arriving Soon Mode</option>
                  </select>
                </div>
              </div>
            </div>
            <button type="button" class="button" onclick="addModeChange()">
              Add Another Mode Change
            </button>
            <button type="submit" class="button">Add Visit</button>
          </form>
        </div>
      </div>

      <div id="config-tab" class="tab-content">
        <div class="section">
          <h2>System Configuration</h2>
          <form id="config-form">
            <div class="form-group">
              <label for="arrivalScheduleTime">Arrival Schedule Time</label>
              <input type="time" id="arrivalScheduleTime" required />
            </div>
            <div class="form-group">
              <label for="departureScheduleTime">Departure Schedule Time</label>
              <input type="time" id="departureScheduleTime" required />
            </div>
            <div class="form-group">
              <label for="arrivingSoonTime">Arriving Soon Time</label>
              <input type="time" id="arrivingSoonTime" required />
            </div>
            <div class="form-group">
              <label for="arrivingSoonDayOffset"
                >Arriving Soon Day Offset</label
              >
              <input
                type="number"
                id="arrivingSoonDayOffset"
                required
                min="0"
                max="7"
              />
            </div>
            <div class="form-group">
              <label for="checkin_mode">Check-in Mode</label>
              <input type="text" id="checkin_mode" required />
            </div>
            <div class="form-group">
              <label for="checkout_mode">Check-out Mode</label>
              <input type="text" id="checkout_mode" required />
            </div>
            <div class="form-group">
              <label for="arriving_soon_mode">Arriving Soon Mode</label>
              <input type="text" id="arriving_soon_mode" required />
            </div>
            <div class="form-group">
              <label for="hubitat_ip">Hubitat IP Address</label>
              <input type="text" id="hubitat_ip" required />
            </div>
            <div class="form-group">
              <label for="hubitat_maker_api_access_token"
                >Hubitat Maker API Token</label
              >
              <input type="text" id="hubitat_maker_api_access_token" required />
            </div>
            <div class="form-group">
              <label for="lock_code_slot">Lock Code Slot</label>
              <input type="text" id="lock_code_slot" required />
            </div>
            <div class="form-group">
              <label for="locks_to_code">Locks to Code (comma-separated)</label>
              <input type="text" id="locks_to_code" required />
            </div>
            <div class="form-group">
              <label for="pushover_user">Pushover User Key</label>
              <input type="text" id="pushover_user" required />
            </div>
            <div class="form-group">
              <label for="pushover_token">Pushover App Token</label>
              <input type="text" id="pushover_token" required />
            </div>
            <button type="submit" class="button">Save Configuration</button>
          </form>
        </div>
      </div>

      <button class="button" onclick="refreshData()">Refresh Data</button>
    </div>

    <script>
      let timezone = "";

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "numeric",
          minute: "numeric",
          timeZoneName: "short",
        });
      }

      function showTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        document
          .querySelector(`.tab[onclick="showTab('${tabName}')"]`)
          .classList.add("active");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`${tabName}-tab`).classList.add("active");
      }

      async function refreshData() {
        try {
          console.log("Refreshing data...");
          await Promise.all([loadConfig(), loadSchedules(), loadVisits()]);
          console.log("Data refresh complete");
        } catch (error) {
          console.log("Error refreshing data:", error);
          alert("Failed to refresh data");
        }
      }

      async function loadSchedules() {
        try {
          const response = await fetch("/api/schedules");
          if (!response.ok) {
            throw new Error("Failed to load schedules");
          }
          const schedules = await response.json();
          console.log("Loaded schedules:", schedules);
          const schedulesDiv = document.getElementById("schedules");
          if (Object.keys(schedules).length === 0) {
            schedulesDiv.innerHTML = "<div>No upcoming reservations</div>";
            return;
          }

          const now = new Date();
          const scheduleHtml = Object.entries(schedules)
            .map(([reservationNumber, schedule]) => {
              const isActive =
                new Date(schedule.start) <= now &&
                new Date(schedule.end) >= now;
              return `
                                  <div class="reservation ${
                                    isActive ? "active" : ""
                                  }">
                                      <div><strong>Reservation:</strong> ${reservationNumber}</div>
                                      <div><strong>Code:</strong> ${
                                        schedule.phoneNumber
                                      }</div>
                                      <div><strong>Check-in:</strong> ${formatDate(
                                        schedule.start
                                      )}</div>
                                      <div><strong>Check-out:</strong> ${formatDate(
                                        schedule.end
                                      )}</div>
                                      ${
                                        schedule.arriving
                                          ? `<div><strong>Arriving Soon:</strong> ${formatDate(
                                              schedule.arriving
                                            )}</div>`
                                          : ""
                                      }
                                  </div>
                              `;
            })
            .join("");
          schedulesDiv.innerHTML = scheduleHtml;
        } catch (error) {
          console.log("Error loading schedules:", error);
          alert("Failed to load schedules");
        }
      }

      async function loadVisits() {
        try {
          const response = await fetch("/api/visits");
          if (!response.ok) {
            throw new Error("Failed to load visits");
          }
          const visits = await response.json();
          console.log("Loaded visits:", visits);
          const visitsDiv = document.getElementById("visits");
          if (visits.length === 0) {
            visitsDiv.innerHTML = "<div>No manual visits scheduled</div>";
            return;
          }

          const now = new Date();
          const visitsHtml = visits
            .map((visit) => {
              const isActive = visit.modeChanges.some(
                (change) =>
                  new Date(change.time) <= now && new Date(change.time) >= now
              );

              return `
                <div class="visit ${isActive ? "active" : ""}">
                  <div><strong>Name:</strong> ${visit.name}</div>
                  ${
                    visit.phone
                      ? `<div><strong>Phone:</strong> ${visit.phone}</div>`
                      : ""
                  }
                  <div><strong>Mode Changes:</strong></div>
                  <ul>
                    ${visit.modeChanges
                      .map(
                        (change) => `
                      <li>${formatDate(change.time)} - ${change.mode
                          .replace("_", " ")
                          .replace(/\b\w/g, (l) => l.toUpperCase())}</li>
                    `
                      )
                      .join("")}
                  </ul>
                  <button class="button delete" onclick="deleteVisit('${
                    visit.id
                  }')">Delete</button>
                </div>
              `;
            })
            .join("");
          visitsDiv.innerHTML = visitsHtml;
        } catch (error) {
          console.log("Error loading visits:", error);
          alert("Failed to load visits");
        }
      }

      // Handle visit form submission
      document
        .getElementById("visit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // Collect all mode changes
          const modeChanges = [];
          let modeChangeCount = 1;
          while (document.getElementById(`time${modeChangeCount}`)) {
            modeChanges.push({
              time: document.getElementById(`time${modeChangeCount}`).value,
              mode: document.getElementById(`mode${modeChangeCount}`).value,
            });
            modeChangeCount++;
          }

          const visit = {
            name: document.getElementById("name").value,
            phone: document.getElementById("phone").value || null,
            modeChanges: modeChanges,
          };

          try {
            const response = await fetch("/api/visits", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(visit),
            });

            if (response.ok) {
              // Clear form
              e.target.reset();
              // Reset mode changes
              const modeChangesDiv = document.getElementById("mode-changes");
              modeChangesDiv.innerHTML = `
                <div class="mode-change">
                  <h3>Mode Change #1</h3>
                  <div class="form-group">
                    <label for="time1">Time</label>
                    <input type="datetime-local" id="time1" required />
                  </div>
                  <div class="form-group">
                    <label for="mode1">Mode</label>
                    <select id="mode1" required>
                      <option value="">Select a mode...</option>
                      <option value="checkin">Check-in Mode</option>
                      <option value="checkout">Check-out Mode</option>
                      <option value="arriving_soon">Arriving Soon Mode</option>
                    </select>
                  </div>
                </div>
              `;
              // Refresh data
              refreshData();
            } else {
              alert("Failed to add visit");
            }
          } catch (error) {
            console.log("Error adding visit:", error);
            alert("Failed to add visit");
          }
        });

      function addModeChange() {
        const modeChangesDiv = document.getElementById("mode-changes");
        const currentCount = modeChangesDiv.children.length;

        if (currentCount >= 3) {
          alert("Maximum of 3 mode changes allowed");
          return;
        }

        const newModeChange = document.createElement("div");
        newModeChange.className = "mode-change";
        newModeChange.innerHTML = `
          <h3>Mode Change #${currentCount + 1}</h3>
          <div class="form-group">
            <label for="time${currentCount + 1}">Time</label>
            <input type="datetime-local" id="time${
              currentCount + 1
            }" required />
          </div>
          <div class="form-group">
            <label for="mode${currentCount + 1}">Mode</label>
            <select id="mode${currentCount + 1}" required>
              <option value="">Select a mode...</option>
              <option value="checkin">Check-in Mode</option>
              <option value="checkout">Check-out Mode</option>
              <option value="arriving_soon">Arriving Soon Mode</option>
            </select>
          </div>
          <button type="button" class="button delete" onclick="this.parentElement.remove()">Remove</button>
        `;
        modeChangesDiv.appendChild(newModeChange);
      }

      // Handle visit deletion
      async function deleteVisit(id) {
        if (!confirm("Are you sure you want to delete this visit?")) {
          return;
        }

        try {
          console.log("Deleting visit:", id);
          const response = await fetch(`/api/visits/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            refreshData();
          } else {
            alert("Failed to delete visit");
          }
        } catch (error) {
          console.log("Error deleting visit:", error);
          alert("Failed to delete visit");
        }
      }

      // Add config management functions
      async function loadConfig() {
        try {
          const response = await fetch("/api/config");
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.details || "Failed to load configuration"
            );
          }
          const config = await response.json();
          console.log("Loaded config:", config);

          // Convert times to 24-hour format for time inputs
          if (config.arrivalScheduleTime) {
            document.getElementById("arrivalScheduleTime").value =
              convertTo24Hour(config.arrivalScheduleTime);
          }
          if (config.departureScheduleTime) {
            document.getElementById("departureScheduleTime").value =
              convertTo24Hour(config.departureScheduleTime);
          }
          if (config.arrivingSoonTime) {
            document.getElementById("arrivingSoonTime").value = convertTo24Hour(
              config.arrivingSoonTime
            );
          }

          // Set other fields
          if (config.arrivingSoonDayOffset !== undefined) {
            document.getElementById("arrivingSoonDayOffset").value =
              config.arrivingSoonDayOffset;
          }
          if (config.checkin_mode) {
            document.getElementById("checkin_mode").value = config.checkin_mode;
          }
          if (config.checkout_mode) {
            document.getElementById("checkout_mode").value =
              config.checkout_mode;
          }
          if (config.arriving_soon_mode) {
            document.getElementById("arriving_soon_mode").value =
              config.arriving_soon_mode;
          }
          if (config.hubitat_ip) {
            document.getElementById("hubitat_ip").value = config.hubitat_ip;
          }
          if (config.hubitat_maker_api_access_token) {
            document.getElementById("hubitat_maker_api_access_token").value =
              config.hubitat_maker_api_access_token;
          }
          if (config.lock_code_slot) {
            document.getElementById("lock_code_slot").value =
              config.lock_code_slot;
          }
          if (config.locks_to_code) {
            document.getElementById("locks_to_code").value =
              config.locks_to_code.join(", ");
          }
          if (config.pushover && config.pushover.user) {
            document.getElementById("pushover_user").value =
              config.pushover.user;
          }
          if (config.pushover && config.pushover.token) {
            document.getElementById("pushover_token").value =
              config.pushover.token;
          }
        } catch (error) {
          console.log("Error loading config:", error);
          alert(`Failed to load configuration: ${error.message}`);
        }
      }

      function convertTo24Hour(time12h) {
        const [time, modifier] = time12h.split(" ");
        let [hours, minutes] = time.split(":");
        hours = parseInt(hours);
        if (modifier === "PM" && hours < 12) hours += 12;
        if (modifier === "AM" && hours === 12) hours = 0;
        return `${hours.toString().padStart(2, "0")}:${minutes}`;
      }

      function convertTo12Hour(time24h) {
        const [hours, minutes] = time24h.split(":");
        const hour = parseInt(hours);
        const modifier = hour >= 12 ? "PM" : "AM";
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${modifier}`;
      }

      // Handle config form submission
      document
        .getElementById("config-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const config = {
            arrivalScheduleTime: convertTo12Hour(
              document.getElementById("arrivalScheduleTime").value
            ),
            departureScheduleTime: convertTo12Hour(
              document.getElementById("departureScheduleTime").value
            ),
            arrivingSoonTime: convertTo12Hour(
              document.getElementById("arrivingSoonTime").value
            ),
            arrivingSoonDayOffset: parseInt(
              document.getElementById("arrivingSoonDayOffset").value
            ),
            checkin_mode: document.getElementById("checkin_mode").value,
            checkout_mode: document.getElementById("checkout_mode").value,
            arriving_soon_mode:
              document.getElementById("arriving_soon_mode").value,
            hubitat_ip: document.getElementById("hubitat_ip").value,
            hubitat_maker_api_access_token: document.getElementById(
              "hubitat_maker_api_access_token"
            ).value,
            lock_code_slot: document.getElementById("lock_code_slot").value,
            locks_to_code: document
              .getElementById("locks_to_code")
              .value.split(",")
              .map((s) => s.trim()),
            pushover: {
              user: document.getElementById("pushover_user").value,
              token: document.getElementById("pushover_token").value,
            },
          };

          try {
            const response = await fetch("/api/config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(config),
            });

            if (response.ok) {
              alert("Configuration saved successfully");
              loadConfig(); // Reload to ensure we have the latest values
            } else {
              alert("Failed to save configuration");
            }
          } catch (error) {
            console.log("Error saving config:", error);
            alert("Failed to save configuration");
          }
        });

      // Load config when the page loads
      loadConfig();

      // Initial load
      refreshData();
    </script>
  </body>
</html>
